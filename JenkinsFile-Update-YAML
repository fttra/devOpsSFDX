@Library('Jenkinstools@master') _
@Field Boolean settingsLoaded

node {
    def sfdxHome = tool 'sfdx'
    def devHubName = "${params.Environment}"
    def objectType = "${params.Object}"


    //credential folder
    
    def resource = libraryResource resource: 'updateData-config.yml'
    println(resource)
    def config = readYaml text: resource

    def branchToCheckout = "master"
    def targetProjectDirName = "esd-pmi-dx"
    def repoUrl = "https://source.app.pconnect.biz/scm/esdp/esd-pmi-salesforce.git"
    def email = 
    def name = 


withEnv(["HOME=${env.WORKSPACE}"]){

    stage ('Checkout on branch'){
        checkoutSourceRepository(config, )
    }

    stage ('Validate environment'){
        validateEnvironment(config, devHubName)
    }

    stage ('Validate file to upload'){
        validateFile(objectType)
    }

    stage('Authentication to Salesforce') {
        authenticateToSalesforce(sfdxHome, config, devHubName)
	}

	stage('Update file'){
        logoutFromSalesforce(sfdxHome)
        authenticateToSalesforce(sfdxHome, config, devHubName)
        updateFiles(sfdxHome, config, devHubName, objectType)
    }
	 stage('Logout'){
	 	logoutFromSalesforce(sfdxHome)
	    }
}
}




def authenticateToSalesforce(sfdxHome, config, org){
    withCredentials([
        string(credentialsId: config.credentials[org].connapp_consumerkey_id, variable: 'CLIENT_ID'),
        file(credentialsId: config.credentials[org].cred_id,  variable: 'KEY_FILE'),
    ]) {
        
        def rc = sh returnStatus: true, script: "${sfdxHome}/sfdx force:auth:jwt:grant  -i ${CLIENT_ID} -u ${config.credentials[org].username} -f ${KEY_FILE}  --setdefaultusername"
        if (rc != 0) { error 'Authorization failed' }

        println rc
    } 
}

def validateEnvironment (config, org){
    if(config.credentials[org] == null){
        error ("There is no environment with the name: " + org)
    }
    print config.credentials[org]
}

def logoutFromSalesforce(sfdxHome){
    def logoutStatus = sh returnStatus: true, script: "${sfdxHome}/sfdx force:auth:logout -a -p --json > logout.json"

    if (logoutStatus!=0){
        jsonOut = readJSON file: 'logout.json'
        if (jsonOut.name != 'noOrgsFound'){
            error(jsonOut.message)
        } else {
            println("No orgs to be logout from")
        }
    }

	println "Successfully logout from Salesforce"
}

def validateFile (objectType){
    if (!fileExists("data/${objectType}.csv")){
        error ("There is no file to update records or the file has a different name than the object You want to update")
    } else {
        println ("File was found. Proceeding ... ")
    }
}

def updateFiles (sfdxHome, config, org, objectType) {
    	def con = sh returnStdout: true, script: "${sfdxHome}/sfdx force:data:bulk:upsert -s ${objectType} -f data/${objectType}.csv -i Id -u ${config.credentials[org].username}"
		println con
}

def checkoutSourceRepository(config, repoUrl, targetProjectDirName, branchToCheckout){
    checkout([
                    $class           : 'GitSCM',
                    branches         : [[name: "${branchToCheckout}"]],
                    extensions       : [[$class: 'UserIdentity', email: "${email}", name: name],
                                        [$class: 'CleanBeforeCheckout'],
                                        [$class: 'RelativeTargetDirectory', relativeTargetDir: "${targetProjectDirName}"],
                    userRemoteConfigs: [[credentialsId: , url: repoUrl]]
            ])
}
